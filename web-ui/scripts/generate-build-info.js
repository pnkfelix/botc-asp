#!/usr/bin/env node
// Build script to embed build-time information (like latest merged PR number)
// This generates src/BuildInfo.js which can be imported via FFI

import { execSync } from 'child_process';
import { writeFileSync } from 'fs';
import { dirname, join } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const projectRoot = join(__dirname, '..');

function getLatestMergedPR() {
  try {
    // Look through recent commits for "Merge pull request #XX" pattern
    // This is the format GitHub uses for merge commits
    const gitLog = execSync('git log --oneline -20', {
      encoding: 'utf-8',
      cwd: join(projectRoot, '..')  // Run from repo root
    });

    const lines = gitLog.split('\n');
    for (const line of lines) {
      const match = line.match(/Merge pull request #(\d+)/);
      if (match) {
        return parseInt(match[1], 10);
      }
    }
    return null;
  } catch (error) {
    console.warn('Could not extract PR number from git history:', error.message);
    return null;
  }
}

const latestPR = getLatestMergedPR();

// Generate the JS module
const output = `// Auto-generated by scripts/generate-build-info.js - do not edit manually
// Run 'npm run build-info' to regenerate

// Latest merged PR number (extracted from git history at build time)
export const latestMergedPRImpl = ${latestPR === null ? 'null' : latestPR};

// Build timestamp
export const buildTimestamp = "${new Date().toISOString()}";
`;

const outputPath = join(projectRoot, 'src', 'BuildInfo.js');
writeFileSync(outputPath, output);

console.log(`Generated ${outputPath}`);
if (latestPR !== null) {
  console.log(`Latest merged PR: #${latestPR}`);
} else {
  console.log('No merged PR found in recent git history');
}
